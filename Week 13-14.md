# 硬件和软件集成

## 将情感识别算法集成到Arduino硬件中

Arduino主板接收数据并控制相对应的气泵和气阀实现气球的充放气

根据情绪地图上情绪相对应的情绪位置和openCV所带有的情绪标签，进一步完善Arduino代码

七种情绪：愤怒、恐惧、厌恶、幸福、悲伤、惊奇、中立
六个部位：头部、躯干、左手、右手、左腿、右腿
情绪和部位的对应关系：
1、愤怒：头部、左手、右手
2、恐惧：头部、躯干
3、厌恶：头部
4、幸福：躯干、左手、右手
5、悲伤：躯干、左腿、右腿
6、惊奇：头部、左腿、右腿
7、中立：无

为模拟情绪变化对于的人体不同的部位的影响，采用气球充放气的情景使其具象化。即在6个身体部位分别用6个气球，当检测到某种情绪时，对应部位的气球变大和变小来模拟身体的反应。

如何实现气球的大小变化呢？我采用气泵和两位三通气阀通过软管与气球相连组成充放气回路，充气时，气泵通过气阀与气球相连，放气时，气球通过气泵与大气相连。一个气球需要一组气泵与气阀，所以总共需要6组气泵与气阀。然后使用arduino uno主板与扩展板来控制6组气泵与气阀的工作状态。

要实现情绪分析，必须要有摄像头进行摄像，这里我选择笔记本电脑自带的摄像头，一是不用外接、方便调用，二是脚本本身运行在电脑里，只需要和arduino进行串口通讯就可以方便的控制运动部件。

```ruby

Servo servo_head_1; //头部泵
Servo servo_head_2; //头部气阀
Servo servo_chest_1; //胸部泵
Servo servo_chest_2; //胸部气阀
Servo servo_l_hand_1; //左手泵
Servo servo_l_hand_2; //左手气阀
Servo servo_r_hand_1; //右手泵
Servo servo_r_hand_2; //右手气阀
Servo servo_l_leg_1; //左腿泵
Servo servo_l_leg_2; //左腿气阀
Servo servo_r_leg_1; //右腿泵
Servo servo_r_leg_2; //右腿气阀
//int servo_A0 = A0; //定义舵机接口A0   //腰部泵
//int servo_A1 = A1; //定义舵机接口A1   //腰部气阀
//int myangle;//定义角度变量
//int pulsewidth;//定义脉宽变量
//int val;
//
//void servopulse(int servopin, int myangle) //定义一个脉冲函数
//{
//  pulsewidth = (myangle * 11) + 500; //将角度转化为500-2480的脉宽值
//  digitalWrite(servopin, HIGH); //将舵机接口电平至高
//  delayMicroseconds(pulsewidth);//延时脉宽值的微秒数
//  digitalWrite(servopin, LOW); //将舵机接口电平至低
//  delay(20 - pulsewidth / 1000);
//}


```

气泵和气阀是通过PWM来控制的
```ruby

void angry() {         //头/左手/右手
  for(int i=0;i<3;i++)
  {
    servo_head_1.write(180);
    servo_head_2.write(0);
//    servo_chest_1.write(180);
//    servo_chest_2.write(0);
    servo_l_hand_1.write(180);
    servo_l_hand_2.write(0);
    servo_r_hand_1.write(180);
    servo_r_hand_2.write(0);
    delay(4000);
    servo_head_1.write(0);
    servo_head_2.write(0);
//    servo_chest_1.write(0);
//    servo_chest_2.write(0);
    servo_l_hand_1.write(0);
    servo_l_hand_2.write(0);
    servo_r_hand_1.write(0);
    servo_r_hand_2.write(0);
    delay(1000);
    servo_head_1.write(0);
    servo_head_2.write(180);
//    servo_chest_1.write(0);
//    servo_chest_2.write(180);
    servo_l_hand_1.write(0);
    servo_l_hand_2.write(180);
    servo_r_hand_1.write(0);
    servo_r_hand_2.write(180);
    delay(3000);
   // delay(3000);
  }
  servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}

void fear() {
  for(int i=0;i<3;i++)
  {
//    servopulse(servo_A0, 180);
//    servopulse(servo_A1, 0);
    servo_head_1.write(180);
    servo_head_2.write(0);
    servo_chest_1.write(180);
    servo_chest_2.write(0);
    delay(4000);
    servo_head_1.write(0);
    servo_head_2.write(0);
    servo_chest_1.write(0);
    servo_chest_2.write(0);
    delay(1000);
    servo_head_1.write(0);
    servo_head_2.write(180);
    servo_chest_1.write(0);
    servo_chest_2.write(180);
    delay(3000);
    //delay(3000);
  }
    servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}

void disgust() {
  for(int i=0;i<3;i++)
  {
    servo_head_1.write(180);
    servo_head_2.write(0);
    delay(4000);
    servo_head_1.write(0);
    servo_head_2.write(0);
    delay(1000);
    servo_head_1.write(0);
    servo_head_2.write(180);
    delay(3000);
    //delay(3000);
  }
    servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}

void happy() {
  for(int i=0;i<3;i++)
  {
//    servo_head_1.write(180);
//    servo_head_2.write(0);
    servo_chest_1.write(180);
    servo_chest_2.write(0);
    servo_l_hand_1.write(180);
    servo_l_hand_2.write(0);
    servo_r_hand_1.write(180);
    servo_r_hand_2.write(0);
//    servo_l_leg_1.write(180);
//    servo_l_leg_2.write(0);
//    servo_r_leg_1.write(180);
//    servo_r_leg_2.write(0);
    delay(4000);
//    servo_head_1.write(0);
//    servo_head_2.write(0);
    servo_chest_1.write(0);
    servo_chest_2.write(0);
    servo_l_hand_1.write(0);
    servo_l_hand_2.write(0);
    servo_r_hand_1.write(0);
    servo_r_hand_2.write(0);
//    servo_l_leg_1.write(0);
//    servo_l_leg_2.write(0);
//    servo_r_leg_1.write(0);
//    servo_r_leg_2.write(0);
    delay(1000);
//    servo_head_1.write(0);
//    servo_head_2.write(180);
    servo_chest_1.write(0);
    servo_chest_2.write(180);
    servo_l_hand_1.write(0);
    servo_l_hand_2.write(180);
    servo_r_hand_1.write(0);
    servo_r_hand_2.write(180);
//    servo_l_leg_1.write(0);
//    servo_l_leg_2.write(180);
//    servo_r_leg_1.write(0);
//    servo_r_leg_2.write(180);
    delay(3000);
    //delay(3000);
  }
    servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}

void sad() {
  for(int i=0;i<3;i++)
  {
    servo_chest_1.write(180);
    servo_chest_2.write(0);
    servo_l_leg_1.write(180);
    servo_l_leg_2.write(0);
    servo_r_leg_1.write(180);
    servo_r_leg_2.write(0);
    delay(4000);
    servo_chest_1.write(0);
    servo_chest_2.write(0);
    servo_l_leg_1.write(0);
    servo_l_leg_2.write(0);
    servo_r_leg_1.write(0);
    servo_r_leg_2.write(0);
    delay(1000);
    servo_chest_1.write(0);
    servo_chest_2.write(180);
    servo_l_leg_1.write(0);
    servo_l_leg_2.write(180);
    servo_r_leg_1.write(0);
    servo_r_leg_2.write(180);
    delay(3000);
    //delay(3000);
  }
    servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}

void surprise() {                         //头/左脚/右脚
  for(int i=0;i<3;i++)
  {
    servo_head_1.write(180);
    servo_head_2.write(0);
//    servo_chest_1.write(180);
//    servo_chest_2.write(0);
    servo_l_leg_1.write(180);
    servo_l_leg_2.write(0);
    servo_r_leg_1.write(180);
    servo_r_leg_2.write(0);
    delay(4000);
    servo_head_1.write(0);
    servo_head_2.write(0);
//    servo_chest_1.write(0);
//    servo_chest_2.write(0);
    servo_l_leg_1.write(0);
    servo_l_leg_2.write(0);
    servo_r_leg_1.write(0);
    servo_r_leg_2.write(0);
    delay(1000);
    servo_head_1.write(0);
    servo_head_2.write(180);
//    servo_chest_1.write(0);
//    servo_chest_2.write(180);
    servo_l_leg_1.write(0);
    servo_l_leg_2.write(180);
    servo_r_leg_1.write(0);
    servo_r_leg_2.write(180);
    delay(3000);
   // delay(3000);
  }
    servo_head_2.write(0);
  servo_chest_2.write(0);
  servo_l_hand_2.write(0);
  servo_r_hand_2.write(0);
  servo_l_leg_2.write(0);
  servo_r_leg_2.write(0);
}
```
由于中立情绪没有动作，根据其余的6种情绪定义6个函数，在每个函数里写入对应的部位的气泵和气阀的充放气动作。

```ruby
void setup() {
  Serial.begin(9600); 
  //Serial.println("test");
  //Serial.setTimeout(50);
  servo_head_1.attach(2);
  servo_head_2.attach(3);
  servo_chest_1.attach(4);
  servo_chest_2.attach(5);
  servo_l_hand_1.attach(6);
  servo_l_hand_2.attach(7);
  servo_r_hand_1.attach(8);
  servo_r_hand_2.attach(9);
  servo_l_leg_1.attach(10);
  servo_l_leg_2.attach(11);
  servo_r_leg_1.attach(12);
  servo_r_leg_2.attach(13);

}

```

```ruby

void loop() {

  String data;
  while (Serial.available() > 0) {
    data += char(Serial.read());
    delay(2); //延时一会，让串口缓存准备好下一个数字，不延时会导致数据丢失
  }
  if (data.length() > 0){
    if (data.startsWith("happy"))
    {
      happy();  
    }
    if (data.startsWith("angry"))
    { 
      angry();
    }
    if (data.startsWith("sad"))
    {
      sad();
    }
    if (data.startsWith("fear"))
    { 
      fear();
    }
    if (data.startsWith("surprise"))
    {
      surprise();
    }
    if (data.startsWith("disgust"))
    { 
      disgust();
    }
    //Serial.println(data);
    data="";
   }
   while(Serial.read()>0);
   delay(200);
    // 处理接收到的数据
}

```

## 测试算法与电机控制的集成

![屏幕截图 2023-11-23 005637](https://github.com/luoq03/Creative-Making-MSc-Advanced-Project-/assets/57748663/5f9a8a53-d853-4c5d-b7f4-de296f63032d)

![屏幕截图 2023-11-23 005553](https://github.com/luoq03/Creative-Making-MSc-Advanced-Project-/assets/57748663/87090edb-94b4-4374-ae48-2b6efa0ec53d)

https://github.com/luoq03/Creative-Making-MSc-Advanced-Project-/assets/57748663/9d990c9c-7c0e-456a-97d1-eec662b8c44a

